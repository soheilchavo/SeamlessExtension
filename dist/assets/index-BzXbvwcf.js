(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();var g=class extends Error{constructor(e,t,s,o){super(e),this.name="ApiError",this.statusCode=t,this.requestId=s,this.details=o}},p=class extends g{constructor(e,t){super(e,401,t),this.name="UnauthorizedError"}},f=class extends g{constructor(e,t,s){super(e,422,t,s),this.name="ValidationError"}},w=class extends g{constructor(e,t){super(e,404,t),this.name="NotFoundError"}},h=class extends g{constructor(e,t){super(e),this.name="NetworkError",this.cause=t}},S=class extends g{constructor(e,t,s){super(e,500,t,s),this.name="ServerError"}},y=class{constructor(e){if(!e.apiKey||typeof e.apiKey!="string")throw new Error("apiKey is required and must be a string");this.baseUrl=e.baseUrl,this.apiKey=e.apiKey}async request(e,t={}){const s=`${this.baseUrl}${e}`,o=new AbortController;try{const r=await fetch(s,{...t,signal:o.signal,credentials:"include",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,...t.headers}});if(!r.ok){const i=await r.json().catch(()=>({error:"unknown_error",message:r.statusText})),n=i.message||i.error;throw r.status===401?new p(n||"Invalid or revoked API key",i.request_id):r.status===422||r.status===400?new f(n,i.request_id,i.details):r.status===404?new w(n,i.request_id):r.status>=500?new S(n,i.request_id,i.details):new g(n,r.status,i.request_id,i.details)}return await r.json()}catch(r){throw r instanceof g?r:r instanceof Error?new h(`Network error: ${r.message}`,r):new h("Unknown network error")}}async createStream(e){return this.request("/streams",{method:"POST",body:JSON.stringify(e)})}async renewLease(e){return this.request(`/streams/${e}/keepalive`,{method:"POST"})}async updatePrompt(e,t){return this.request(`/streams/${e}/config/prompt`,{method:"PATCH",body:JSON.stringify({prompt:t})})}async submitFeedback(e,t){return this.request(`/streams/${e}/feedback`,{method:"POST",body:JSON.stringify(t)})}async getAllFeedback(){return this.request("/streams/feedback",{method:"GET"})}connectWebSocket(e){const t=this.baseUrl.replace("http://","ws://").replace("https://","wss://");return new WebSocket(`${t}/ws/streams/${e}`)}async healthCheck(){const e=`${this.baseUrl}/healthz`;return(await fetch(e,{credentials:"include"})).text()}},c={BACKEND:"overshoot",MODEL:"Qwen/Qwen3-VL-30B-A3B-Instruct",SOURCE:{type:"camera",cameraFacing:"environment"},SAMPLING_RATIO:.1,CLIP_LENGTH_SECONDS:1,DELAY_SECONDS:1,FALLBACK_FPS:30,ICE_SERVERS:[{urls:"turn:34.63.114.235:3478",username:"1769538895:c66a907c-61f4-4ec2-93a6-9d6b932776bb",credential:"Fu9L4CwyYZvsOLc+23psVAo3i/Y="}]},a={SAMPLING_RATIO:{min:0,max:1},FPS:{min:1,max:120},CLIP_LENGTH_SECONDS:{min:.1,max:60},DELAY_SECONDS:{min:0,max:60},RATING:{min:1,max:5}},E=class{constructor(e=!1){this.debugEnabled=e}debug(...e){this.debugEnabled&&console.log("[RealtimeVision Debug]",...e)}info(...e){console.log("[RealtimeVision]",...e)}warn(...e){console.warn("[RealtimeVision]",...e)}error(...e){console.error("[RealtimeVision]",...e)}},l=class extends Error{constructor(e){super(e),this.name="ValidationError"}},v=class{constructor(e){this.mediaStream=null,this.peerConnection=null,this.webSocket=null,this.streamId=null,this.keepaliveInterval=null,this.videoElement=null,this.isRunning=!1,this.validateConfig(e),this.config=e,this.logger=new E(e.debug??!1),this.client=new y({baseUrl:e.apiUrl,apiKey:e.apiKey})}validateConfig(e){var t,s,o,r;if(!e.apiUrl||typeof e.apiUrl!="string")throw new l("apiUrl is required and must be a string");if(!e.apiKey||typeof e.apiKey!="string")throw new l("apiKey is required and must be a string");if(!e.prompt||typeof e.prompt!="string")throw new l("prompt is required and must be a string");if(e.source)if(e.source.type==="camera"){if(e.source.cameraFacing!=="user"&&e.source.cameraFacing!=="environment")throw new l('cameraFacing must be "user" or "environment"')}else if(e.source.type==="video"){if(!(e.source.file instanceof File))throw new l("video source must provide a File object")}else throw new l('source.type must be "camera" or "video"');if(((t=e.processing)==null?void 0:t.sampling_ratio)!==void 0){const i=e.processing.sampling_ratio;if(i<a.SAMPLING_RATIO.min||i>a.SAMPLING_RATIO.max)throw new l(`sampling_ratio must be between ${a.SAMPLING_RATIO.min} and ${a.SAMPLING_RATIO.max}`)}if(((s=e.processing)==null?void 0:s.fps)!==void 0){const i=e.processing.fps;if(i<a.FPS.min||i>a.FPS.max)throw new l(`fps must be between ${a.FPS.min} and ${a.FPS.max}`)}if(((o=e.processing)==null?void 0:o.clip_length_seconds)!==void 0){const i=e.processing.clip_length_seconds;if(i<a.CLIP_LENGTH_SECONDS.min||i>a.CLIP_LENGTH_SECONDS.max)throw new l(`clip_length_seconds must be between ${a.CLIP_LENGTH_SECONDS.min} and ${a.CLIP_LENGTH_SECONDS.max}`)}if(((r=e.processing)==null?void 0:r.delay_seconds)!==void 0){const i=e.processing.delay_seconds;if(i<a.DELAY_SECONDS.min||i>a.DELAY_SECONDS.max)throw new l(`delay_seconds must be between ${a.DELAY_SECONDS.min} and ${a.DELAY_SECONDS.max}`)}}async createMediaStream(e){switch(this.logger.debug("Creating media stream from source:",e.type),e.type){case"camera":return await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:e.cameraFacing}},audio:!1});case"video":const t=document.createElement("video");t.src=URL.createObjectURL(e.file),t.muted=!0,t.loop=!0,t.playsInline=!0,this.logger.debug("Loading video file:",e.file.name),await new Promise((r,i)=>{const n=setTimeout(()=>{i(new Error("Video loading timeout after 10 seconds"))},1e4);t.onloadedmetadata=()=>{clearTimeout(n),this.logger.debug("Video metadata loaded"),r()},t.onerror=d=>{clearTimeout(n),this.logger.error("Video loading error:",d),i(new Error("Failed to load video file"))},t.readyState>=1&&(clearTimeout(n),r())}),await t.play(),this.logger.debug("Video playback started");const s=t.captureStream();if(!s)throw new Error("Failed to capture video stream");if(s.getVideoTracks().length===0)throw new Error("Video stream has no video tracks");return this.videoElement=t,s;default:throw new Error(`Unknown source type: ${e.type}`)}}async getStreamFps(e,t){if(!e)return this.logger.warn("Stream is null, using fallback FPS"),c.FALLBACK_FPS;const s=e.getVideoTracks();if(!s||s.length===0)return this.logger.warn("No video tracks found, using fallback FPS"),c.FALLBACK_FPS;const o=s[0];if(!o)return this.logger.warn("First video track is null, using fallback FPS"),c.FALLBACK_FPS;if(t.type==="camera"){const i=o.getSettings().frameRate??c.FALLBACK_FPS;return this.logger.debug("Detected camera FPS:",i),i}return t.type==="video"&&this.videoElement&&(await new Promise((r,i)=>{this.videoElement.readyState>=1?r():(this.videoElement.onloadedmetadata=()=>r(),this.videoElement.onerror=()=>i(new Error("Failed to load video metadata")))}),this.logger.debug("Using fallback FPS for video file")),c.FALLBACK_FPS}getProcessingConfig(e){const t=this.config.processing||{};return{sampling_ratio:t.sampling_ratio??c.SAMPLING_RATIO,fps:t.fps??e,clip_length_seconds:t.clip_length_seconds??c.CLIP_LENGTH_SECONDS,delay_seconds:t.delay_seconds??c.DELAY_SECONDS}}getSource(){return this.config.source??c.SOURCE}async start(){var e;if(this.isRunning)throw new Error("Vision stream already running");try{const t=this.getSource();if(this.logger.debug("Starting stream with source type:",t.type),t.type==="video"&&(this.logger.debug("Video file:",{name:t.file.name,size:t.file.size,type:t.file.type}),!t.file||!(t.file instanceof File)))throw new Error("Invalid video file");this.mediaStream=await this.createMediaStream(t);const s=this.mediaStream.getVideoTracks()[0];if(!s)throw new Error("No video track available");const o=await this.getStreamFps(this.mediaStream,t),r=this.config.iceServers??c.ICE_SERVERS;this.logger.debug("Creating peer connection with ICE servers"),this.peerConnection=new RTCPeerConnection({iceServers:r}),this.peerConnection.onicecandidate=d=>{d.candidate?this.logger.debug("ICE candidate:",{type:d.candidate.type,protocol:d.candidate.protocol}):this.logger.debug("ICE gathering complete")},this.peerConnection.oniceconnectionstatechange=()=>{var d;this.logger.debug("ICE connection state:",(d=this.peerConnection)==null?void 0:d.iceConnectionState)},this.peerConnection.addTrack(s,this.mediaStream);const i=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(i),!this.peerConnection.localDescription)throw new Error("Failed to create local description");this.logger.debug("Creating stream on server");const n=await this.client.createStream({webrtc:{type:"offer",sdp:this.peerConnection.localDescription.sdp},processing:this.getProcessingConfig(o),inference:{prompt:this.config.prompt,backend:this.config.backend??c.BACKEND,model:this.config.model??c.MODEL,output_schema_json:this.config.outputSchema}});this.logger.debug("Backend response received:",{stream_id:n.stream_id,has_turn_servers:!!n.turn_servers}),await this.peerConnection.setRemoteDescription(n.webrtc),this.streamId=n.stream_id,this.logger.info("Stream started:",this.streamId),this.setupKeepalive((e=n.lease)==null?void 0:e.ttl_seconds),this.setupWebSocket(n.stream_id),this.isRunning=!0}catch(t){throw await this.handleFatalError(t),t}}setupKeepalive(e){if(!e)return;const t=e/2*1e3;this.logger.debug("Setting up keepalive with interval:",t,"ms"),this.keepaliveInterval=window.setInterval(async()=>{try{this.streamId&&(await this.client.renewLease(this.streamId),this.logger.debug("Lease renewed"))}catch(s){this.logger.error("Keepalive failed:",s);const o=new Error(`Keepalive failed: ${s instanceof Error?s.message:String(s)}`);await this.handleFatalError(o)}},t)}setupWebSocket(e){this.logger.debug("Connecting WebSocket for stream:",e),this.webSocket=this.client.connectWebSocket(e),this.webSocket.onopen=()=>{this.logger.debug("WebSocket connected"),this.webSocket&&this.webSocket.send(JSON.stringify({api_key:this.config.apiKey}))},this.webSocket.onmessage=t=>{try{const s=JSON.parse(t.data);this.config.onResult(s)}catch(s){const o=new Error(`Failed to parse WebSocket message: ${s instanceof Error?s.message:String(s)}`);this.handleNonFatalError(o)}},this.webSocket.onerror=()=>{this.logger.error("WebSocket error occurred");const t=new Error("WebSocket error occurred");this.handleFatalError(t)},this.webSocket.onclose=t=>{if(this.isRunning)if(t.code===1008){this.logger.error("WebSocket authentication failed");const s=new Error("WebSocket authentication failed: Invalid or revoked API key");this.handleFatalError(s)}else{this.logger.warn("WebSocket closed unexpectedly:",t.code);const s=new Error("WebSocket closed unexpectedly");this.handleFatalError(s)}else this.logger.debug("WebSocket closed")}}handleNonFatalError(e){this.logger.warn("Non-fatal error:",e.message),this.config.onError&&this.config.onError(e)}async handleFatalError(e){this.logger.error("Fatal error:",e),await this.cleanup(),this.isRunning=!1;const t=e instanceof Error?e:new Error(String(e));this.config.onError&&this.config.onError(t)}async updatePrompt(e){if(!this.isRunning||!this.streamId)throw new Error("Vision stream not running");if(!e||typeof e!="string")throw new l("prompt must be a non-empty string");this.logger.debug("Updating prompt"),await this.client.updatePrompt(this.streamId,e),this.logger.info("Prompt updated")}async stop(){this.logger.info("Stopping stream"),await this.cleanup(),this.isRunning=!1}async submitFeedback(e){if(!this.streamId)throw new Error("No active stream");if(e.rating<a.RATING.min||e.rating>a.RATING.max)throw new l(`rating must be between ${a.RATING.min} and ${a.RATING.max}`);if(!e.category||typeof e.category!="string")throw new l("category must be a non-empty string");this.logger.debug("Submitting feedback"),await this.client.submitFeedback(this.streamId,{rating:e.rating,category:e.category,feedback:e.feedback??""}),this.logger.info("Feedback submitted")}getStreamId(){return this.streamId}getMediaStream(){return this.mediaStream}isActive(){return this.isRunning}async cleanup(){this.logger.debug("Cleaning up resources"),this.keepaliveInterval&&(window.clearInterval(this.keepaliveInterval),this.keepaliveInterval=null),this.webSocket&&(this.webSocket.close(),this.webSocket=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.videoElement&&(this.videoElement.pause(),URL.revokeObjectURL(this.videoElement.src),this.videoElement.remove(),this.videoElement=null),this.streamId=null,this.logger.debug("Cleanup complete")}};const b="ovs_148da6c73eff6fdde6431e7bc82e0dd8";console.log("Script loaded");let m=null,u=null;document.addEventListener("DOMContentLoaded",async()=>{async function e(){const o=(await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="videoinput"),r=document.getElementById("camera-select");r.innerHTML=o.map((i,n)=>`<option value="${i.deviceId}">${i.label||"Camera "+(n+1)}</option>`).join("")}await e();async function t(){if(!document.getElementById("camera-select").value){document.getElementById("results").innerText="Please select a camera first!";return}u&&await u.stop(),u=new v({apiUrl:"https://cluster1.overshoot.ai/api/v0.2",apiKey:b,prompt:'Identify all clothing items visible in the image. For each item, describe: type, color, pattern, and style. If no clothing is found, say "No clothing found".',source:{type:"camera",cameraFacing:"user"},outputSchema:{type:"object",properties:{items:{type:"array",items:{type:"object",properties:{type:{type:"string"},color:{type:"string"},pattern:{type:"string"},style:{type:"string"}}}}}},onResult:r=>{console.log("Got result:",r);try{m=typeof r=="string"?JSON.parse(r):r.result?typeof r.result=="string"?JSON.parse(r.result):r.result:r,console.log("Parsed clothing data:",m),document.getElementById("results").innerText=JSON.stringify(m,null,2)}catch(i){console.log("Parse error:",i),console.log("Raw result:",r),document.getElementById("results").innerText=typeof r=="string"?r:JSON.stringify(r,null,2)}},onMessage:r=>{console.log("Got message:",r)},onStatusChange:r=>{console.log("Status changed:",r),document.getElementById("results").innerText="Status: "+r},onError:r=>{console.error("Vision error:",r),document.getElementById("results").innerText="An error occurred: "+(r.message||JSON.stringify(r))}}),await u.start(),console.log("Vision started with camera.")}document.getElementById("find-btn").onclick=()=>{document.getElementById("results").innerText="Detecting clothing...",t()},document.getElementById("start-btn").onclick=async()=>{const o=document.getElementById("camera-select").value,r=document.getElementById("preview");console.log("Starting camera with device:",o);try{const i=await navigator.mediaDevices.getUserMedia({video:{deviceId:o?{exact:o}:void 0}});r.srcObject=i,console.log("Camera started successfully"),await e()}catch(i){console.error("Error starting camera:",i),document.getElementById("results").innerText="Error starting camera: "+i.message}}});
