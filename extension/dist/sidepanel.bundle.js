var f=class extends Error{constructor(e,o,t,r){super(e),this.name="ApiError",this.statusCode=o,this.requestId=t,this.details=r}},I=class extends f{constructor(e,o){super(e,401,o),this.name="UnauthorizedError"}},P=class extends f{constructor(e,o,t){super(e,422,o,t),this.name="ValidationError"}},_=class extends f{constructor(e,o){super(e,404,o),this.name="NotFoundError"}},b=class extends f{constructor(e,o){super(e),this.name="NetworkError",this.cause=o}},N=class extends f{constructor(e,o,t){super(e,500,o,t),this.name="ServerError"}},A=class{constructor(e){if(!e.apiKey||typeof e.apiKey!="string")throw new Error("apiKey is required and must be a string");this.baseUrl=e.baseUrl,this.apiKey=e.apiKey}async request(e,o={}){const t=`${this.baseUrl}${e}`,r=new AbortController;try{const s=await fetch(t,{...o,signal:r.signal,credentials:"include",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,...o.headers}});if(!s.ok){const n=await s.json().catch(()=>({error:"unknown_error",message:s.statusText})),i=n.message||n.error;throw s.status===401?new I(i||"Invalid or revoked API key",n.request_id):s.status===422||s.status===400?new P(i,n.request_id,n.details):s.status===404?new _(i,n.request_id):s.status>=500?new N(i,n.request_id,n.details):new f(i,s.status,n.request_id,n.details)}return await s.json()}catch(s){throw s instanceof f?s:s instanceof Error?new b(`Network error: ${s.message}`,s):new b("Unknown network error")}}async createStream(e){return this.request("/streams",{method:"POST",body:JSON.stringify(e)})}async renewLease(e){return this.request(`/streams/${e}/keepalive`,{method:"POST"})}async updatePrompt(e,o){return this.request(`/streams/${e}/config/prompt`,{method:"PATCH",body:JSON.stringify({prompt:o})})}async submitFeedback(e,o){return this.request(`/streams/${e}/feedback`,{method:"POST",body:JSON.stringify(o)})}async getAllFeedback(){return this.request("/streams/feedback",{method:"GET"})}connectWebSocket(e){const o=this.baseUrl.replace("http://","ws://").replace("https://","wss://");return new WebSocket(`${o}/ws/streams/${e}`)}async healthCheck(){const e=`${this.baseUrl}/healthz`;return(await fetch(e,{credentials:"include"})).text()}},u={BACKEND:"overshoot",MODEL:"Qwen/Qwen3-VL-30B-A3B-Instruct",SOURCE:{type:"camera",cameraFacing:"environment"},SAMPLING_RATIO:.1,CLIP_LENGTH_SECONDS:1,DELAY_SECONDS:1,FALLBACK_FPS:30,ICE_SERVERS:[{urls:"turn:34.63.114.235:3478",username:"1769538895:c66a907c-61f4-4ec2-93a6-9d6b932776bb",credential:"Fu9L4CwyYZvsOLc+23psVAo3i/Y="}]},c={SAMPLING_RATIO:{min:0,max:1},FPS:{min:1,max:120},CLIP_LENGTH_SECONDS:{min:.1,max:60},DELAY_SECONDS:{min:0,max:60},RATING:{min:1,max:5}},T=class{constructor(e=!1){this.debugEnabled=e}debug(...e){this.debugEnabled&&console.log("[RealtimeVision Debug]",...e)}info(...e){console.log("[RealtimeVision]",...e)}warn(...e){console.warn("[RealtimeVision]",...e)}error(...e){console.error("[RealtimeVision]",...e)}},g=class extends Error{constructor(e){super(e),this.name="ValidationError"}},R=class{constructor(e){this.mediaStream=null,this.peerConnection=null,this.webSocket=null,this.streamId=null,this.keepaliveInterval=null,this.videoElement=null,this.isRunning=!1,this.validateConfig(e),this.config=e,this.logger=new T(e.debug??!1),this.client=new A({baseUrl:e.apiUrl,apiKey:e.apiKey})}validateConfig(e){if(!e.apiUrl||typeof e.apiUrl!="string")throw new g("apiUrl is required and must be a string");if(!e.apiKey||typeof e.apiKey!="string")throw new g("apiKey is required and must be a string");if(!e.prompt||typeof e.prompt!="string")throw new g("prompt is required and must be a string");if(e.source)if(e.source.type==="camera"){if(e.source.cameraFacing!=="user"&&e.source.cameraFacing!=="environment")throw new g('cameraFacing must be "user" or "environment"')}else if(e.source.type==="video"){if(!(e.source.file instanceof File))throw new g("video source must provide a File object")}else throw new g('source.type must be "camera" or "video"');if(e.processing?.sampling_ratio!==void 0){const o=e.processing.sampling_ratio;if(o<c.SAMPLING_RATIO.min||o>c.SAMPLING_RATIO.max)throw new g(`sampling_ratio must be between ${c.SAMPLING_RATIO.min} and ${c.SAMPLING_RATIO.max}`)}if(e.processing?.fps!==void 0){const o=e.processing.fps;if(o<c.FPS.min||o>c.FPS.max)throw new g(`fps must be between ${c.FPS.min} and ${c.FPS.max}`)}if(e.processing?.clip_length_seconds!==void 0){const o=e.processing.clip_length_seconds;if(o<c.CLIP_LENGTH_SECONDS.min||o>c.CLIP_LENGTH_SECONDS.max)throw new g(`clip_length_seconds must be between ${c.CLIP_LENGTH_SECONDS.min} and ${c.CLIP_LENGTH_SECONDS.max}`)}if(e.processing?.delay_seconds!==void 0){const o=e.processing.delay_seconds;if(o<c.DELAY_SECONDS.min||o>c.DELAY_SECONDS.max)throw new g(`delay_seconds must be between ${c.DELAY_SECONDS.min} and ${c.DELAY_SECONDS.max}`)}}async createMediaStream(e){switch(this.logger.debug("Creating media stream from source:",e.type),e.type){case"camera":return await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:e.cameraFacing}},audio:!1});case"video":const o=document.createElement("video");o.src=URL.createObjectURL(e.file),o.muted=!0,o.loop=!0,o.playsInline=!0,this.logger.debug("Loading video file:",e.file.name),await new Promise((s,n)=>{const i=setTimeout(()=>{n(new Error("Video loading timeout after 10 seconds"))},1e4);o.onloadedmetadata=()=>{clearTimeout(i),this.logger.debug("Video metadata loaded"),s()},o.onerror=d=>{clearTimeout(i),this.logger.error("Video loading error:",d),n(new Error("Failed to load video file"))},o.readyState>=1&&(clearTimeout(i),s())}),await o.play(),this.logger.debug("Video playback started");const t=o.captureStream();if(!t)throw new Error("Failed to capture video stream");if(t.getVideoTracks().length===0)throw new Error("Video stream has no video tracks");return this.videoElement=o,t;default:throw new Error(`Unknown source type: ${e.type}`)}}async getStreamFps(e,o){if(!e)return this.logger.warn("Stream is null, using fallback FPS"),u.FALLBACK_FPS;const t=e.getVideoTracks();if(!t||t.length===0)return this.logger.warn("No video tracks found, using fallback FPS"),u.FALLBACK_FPS;const r=t[0];if(!r)return this.logger.warn("First video track is null, using fallback FPS"),u.FALLBACK_FPS;if(o.type==="camera"){const n=r.getSettings().frameRate??u.FALLBACK_FPS;return this.logger.debug("Detected camera FPS:",n),n}return o.type==="video"&&this.videoElement&&(await new Promise((s,n)=>{this.videoElement.readyState>=1?s():(this.videoElement.onloadedmetadata=()=>s(),this.videoElement.onerror=()=>n(new Error("Failed to load video metadata")))}),this.logger.debug("Using fallback FPS for video file")),u.FALLBACK_FPS}getProcessingConfig(e){const o=this.config.processing||{};return{sampling_ratio:o.sampling_ratio??u.SAMPLING_RATIO,fps:o.fps??e,clip_length_seconds:o.clip_length_seconds??u.CLIP_LENGTH_SECONDS,delay_seconds:o.delay_seconds??u.DELAY_SECONDS}}getSource(){return this.config.source??u.SOURCE}async start(){if(this.isRunning)throw new Error("Vision stream already running");try{const e=this.getSource();if(this.logger.debug("Starting stream with source type:",e.type),e.type==="video"&&(this.logger.debug("Video file:",{name:e.file.name,size:e.file.size,type:e.file.type}),!e.file||!(e.file instanceof File)))throw new Error("Invalid video file");this.mediaStream=await this.createMediaStream(e);const o=this.mediaStream.getVideoTracks()[0];if(!o)throw new Error("No video track available");const t=await this.getStreamFps(this.mediaStream,e),r=this.config.iceServers??u.ICE_SERVERS;this.logger.debug("Creating peer connection with ICE servers"),this.peerConnection=new RTCPeerConnection({iceServers:r}),this.peerConnection.onicecandidate=i=>{i.candidate?this.logger.debug("ICE candidate:",{type:i.candidate.type,protocol:i.candidate.protocol}):this.logger.debug("ICE gathering complete")},this.peerConnection.oniceconnectionstatechange=()=>{this.logger.debug("ICE connection state:",this.peerConnection?.iceConnectionState)},this.peerConnection.addTrack(o,this.mediaStream);const s=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(s),!this.peerConnection.localDescription)throw new Error("Failed to create local description");this.logger.debug("Creating stream on server");const n=await this.client.createStream({webrtc:{type:"offer",sdp:this.peerConnection.localDescription.sdp},processing:this.getProcessingConfig(t),inference:{prompt:this.config.prompt,backend:this.config.backend??u.BACKEND,model:this.config.model??u.MODEL,output_schema_json:this.config.outputSchema}});this.logger.debug("Backend response received:",{stream_id:n.stream_id,has_turn_servers:!!n.turn_servers}),await this.peerConnection.setRemoteDescription(n.webrtc),this.streamId=n.stream_id,this.logger.info("Stream started:",this.streamId),this.setupKeepalive(n.lease?.ttl_seconds),this.setupWebSocket(n.stream_id),this.isRunning=!0}catch(e){throw await this.handleFatalError(e),e}}setupKeepalive(e){if(!e)return;const o=e/2*1e3;this.logger.debug("Setting up keepalive with interval:",o,"ms"),this.keepaliveInterval=window.setInterval(async()=>{try{this.streamId&&(await this.client.renewLease(this.streamId),this.logger.debug("Lease renewed"))}catch(t){this.logger.error("Keepalive failed:",t);const r=new Error(`Keepalive failed: ${t instanceof Error?t.message:String(t)}`);await this.handleFatalError(r)}},o)}setupWebSocket(e){this.logger.debug("Connecting WebSocket for stream:",e),this.webSocket=this.client.connectWebSocket(e),this.webSocket.onopen=()=>{this.logger.debug("WebSocket connected"),this.webSocket&&this.webSocket.send(JSON.stringify({api_key:this.config.apiKey}))},this.webSocket.onmessage=o=>{try{const t=JSON.parse(o.data);this.config.onResult(t)}catch(t){const r=new Error(`Failed to parse WebSocket message: ${t instanceof Error?t.message:String(t)}`);this.handleNonFatalError(r)}},this.webSocket.onerror=()=>{this.logger.error("WebSocket error occurred");const o=new Error("WebSocket error occurred");this.handleFatalError(o)},this.webSocket.onclose=o=>{if(this.isRunning)if(o.code===1008){this.logger.error("WebSocket authentication failed");const t=new Error("WebSocket authentication failed: Invalid or revoked API key");this.handleFatalError(t)}else{this.logger.warn("WebSocket closed unexpectedly:",o.code);const t=new Error("WebSocket closed unexpectedly");this.handleFatalError(t)}else this.logger.debug("WebSocket closed")}}handleNonFatalError(e){this.logger.warn("Non-fatal error:",e.message),this.config.onError&&this.config.onError(e)}async handleFatalError(e){this.logger.error("Fatal error:",e),await this.cleanup(),this.isRunning=!1;const o=e instanceof Error?e:new Error(String(e));this.config.onError&&this.config.onError(o)}async updatePrompt(e){if(!this.isRunning||!this.streamId)throw new Error("Vision stream not running");if(!e||typeof e!="string")throw new g("prompt must be a non-empty string");this.logger.debug("Updating prompt"),await this.client.updatePrompt(this.streamId,e),this.logger.info("Prompt updated")}async stop(){this.logger.info("Stopping stream"),await this.cleanup(),this.isRunning=!1}async submitFeedback(e){if(!this.streamId)throw new Error("No active stream");if(e.rating<c.RATING.min||e.rating>c.RATING.max)throw new g(`rating must be between ${c.RATING.min} and ${c.RATING.max}`);if(!e.category||typeof e.category!="string")throw new g("category must be a non-empty string");this.logger.debug("Submitting feedback"),await this.client.submitFeedback(this.streamId,{rating:e.rating,category:e.category,feedback:e.feedback??""}),this.logger.info("Feedback submitted")}getStreamId(){return this.streamId}getMediaStream(){return this.mediaStream}isActive(){return this.isRunning}async cleanup(){this.logger.debug("Cleaning up resources"),this.keepaliveInterval&&(window.clearInterval(this.keepaliveInterval),this.keepaliveInterval=null),this.webSocket&&(this.webSocket.close(),this.webSocket=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.videoElement&&(this.videoElement.pause(),URL.revokeObjectURL(this.videoElement.src),this.videoElement.remove(),this.videoElement=null),this.streamId=null,this.logger.debug("Cleanup complete")}};const F="ovs_148da6c73eff6fdde6431e7bc82e0dd8",C="https://web-production-a1e61a.up.railway.app/get-product";console.log("Seamless extension loaded");let p=null;const S=new Map,m=new Map,w=new Set;function y(){try{const e=localStorage.getItem("savedProducts");return e?JSON.parse(e):[]}catch(e){return console.error("Error loading saved products:",e),[]}}function x(e){const o=y();o.find(r=>r.normalizedKey===e.normalizedKey)||(o.push(e),localStorage.setItem("savedProducts",JSON.stringify(o)),console.log("Product saved:",e.itemName))}function k(e){const t=y().filter(r=>r.normalizedKey!==e);localStorage.setItem("savedProducts",JSON.stringify(t)),console.log("Product unsaved:",e)}function O(e){return y().some(t=>t.normalizedKey===e)}function $(e,o){const t=h=>h.toLowerCase().replace(/[^a-z0-9]/g,""),r=t(e),s=t(o);if(r.includes(s)||s.includes(r))return!0;const n=new Set(e.toLowerCase().split(/\s+/)),i=new Set(o.toLowerCase().split(/\s+/)),d=[...n].filter(h=>i.has(h)),a=new Set([...n,...i]);return d.length/a.size>.6}function D(e){for(const[o,t]of S.entries())if($(e,o))return console.log(`Found similar cached item: "${o}" for "${e}"`),t;return null}async function B(e){console.log("=== SEARCH PRODUCT START ==="),console.log("Item name:",e),console.log("Railway URL:",C);try{const o=JSON.stringify({item_name:e});console.log("Request body:",o),console.log("Sending fetch request...");const t=await fetch(C,{method:"POST",headers:{"Content-Type":"application/json"},body:o});console.log("Response received!"),console.log("Response status:",t.status),console.log("Response ok:",t.ok),console.log("Response headers:",[...t.headers.entries()]);const r=await t.text();console.log("Response text:",r);let s;try{s=JSON.parse(r),console.log("Parsed response data:",s)}catch(n){return console.error("Failed to parse response as JSON:",n),{error:"Invalid JSON response: "+r.substring(0,100)}}return console.log("=== SEARCH PRODUCT SUCCESS ==="),s}catch(o){return console.error("=== SEARCH PRODUCT ERROR ==="),console.error("Error type:",o.name),console.error("Error message:",o.message),console.error("Full error:",o),{error:o.message}}}function E(e){console.log("=== DISPLAY PRODUCTS ==="),console.log("Products to display:",e),console.log("Products count:",e?.length);const o=document.getElementById("products");if(console.log("Products container found:",!!o),console.log("Products container element:",o),!o){console.error("ERROR: Products container not found in DOM!");return}if(o.innerHTML="",!e||e.length===0){console.log("No products to display"),o.innerHTML='<div class="no-products">No products found</div>';return}console.log("Creating product cards..."),e.forEach((t,r)=>{console.log(`Processing product ${r}:`,t);const s=document.createElement("div");if(s.className="product-card",t.loading)s.innerHTML=`
                <div class="product-loading">
                    <span class="loading-icon">‚è≥</span>
                    <span>Searching for ${t.itemName}...</span>
                </div>
            `;else if(t.error)s.innerHTML=`
                <div class="product-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span>${t.itemName}: ${t.error}</span>
                </div>
            `;else if(t.url){console.log("Product data:",t),console.log("Image URL:",t.image_url);const n=t.image_url?`<img class="product-image" src="${t.image_url}" alt="${t.itemName}" onerror="this.style.display='none'" />`:`<div class="product-image product-placeholder">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                       <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                       <circle cx="8.5" cy="8.5" r="1.5"/>
                       <polyline points="21 15 16 10 5 21"/>
                     </svg>
                   </div>`,i=O(t.normalizedKey),d=i?"saved":"";s.innerHTML=`
                <button class="save-btn ${d}" data-key="${t.normalizedKey}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${i?"#ff3b5c":"none"}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>
                ${n}
                <div class="product-info">
                    <div class="product-name">${t.itemName||"Product"}</div>
                    ${t.name?`<div class="product-title">${t.name}</div>`:""}
                    ${t.price?`<div class="product-price">${t.price}</div>`:""}
                    ${t.fromCache?'<div class="from-cache">üì¶ Cached</div>':""}
                </div>
                <button class="shop-btn" data-url="${t.url}">Shop Now ‚Üí</button>
            `}else s.innerHTML=`
                <div class="product-not-found">
                    <span class="not-found-icon">üîç</span>
                    <span>${t.itemName}: No product found</span>
                </div>
            `;o.appendChild(s)}),console.log("Final container innerHTML length:",o.innerHTML.length),console.log("Final container children count:",o.children.length),o.querySelectorAll(".shop-btn").forEach(t=>{t.onclick=()=>{const r=t.getAttribute("data-url");r&&window.open(r,"_blank")}}),o.querySelectorAll(".save-btn").forEach(t=>{t.onclick=r=>{r.stopPropagation();const s=t.getAttribute("data-key"),n=e.find(i=>i.normalizedKey===s);t.classList.contains("saved")?(t.classList.remove("saved"),t.querySelector("svg").setAttribute("fill","none"),k(s)):(t.classList.add("saved"),t.querySelector("svg").setAttribute("fill","#ff3b5c"),n&&x(n)),(!document.getElementById("saved-page").style.display||document.getElementById("saved-page").style.display!=="none")&&L()}})}function L(){console.log("=== DISPLAY SAVED PRODUCTS ===");const e=document.getElementById("saved-products");if(!e){console.error("ERROR: Saved products container not found in DOM!");return}const o=y();if(console.log("Saved products count:",o.length),e.innerHTML="",o.length===0){e.innerHTML=`
            <div class="no-saved-products">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <h3>No saved products yet</h3>
                <p>Products you save will appear here</p>
            </div>
        `;return}o.forEach((t,r)=>{console.log(`Processing saved product ${r}:`,t);const s=document.createElement("div");if(s.className="product-card",t.url){const n=t.image_url?`<img class="product-image" src="${t.image_url}" alt="${t.itemName}" onerror="this.style.display='none'" />`:`<div class="product-image product-placeholder">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                       <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                       <circle cx="8.5" cy="8.5" r="1.5"/>
                       <polyline points="21 15 16 10 5 21"/>
                     </svg>
                   </div>`;s.innerHTML=`
                <button class="save-btn saved" data-key="${t.normalizedKey}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ff3b5c" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>
                ${n}
                <div class="product-info">
                    <div class="product-name">${t.itemName||"Product"}</div>
                    ${t.name?`<div class="product-title">${t.name}</div>`:""}
                    ${t.price?`<div class="product-price">${t.price}</div>`:""}
                </div>
                <button class="shop-btn" data-url="${t.url}">Shop Now ‚Üí</button>
            `}e.appendChild(s)}),e.querySelectorAll(".shop-btn").forEach(t=>{t.onclick=()=>{const r=t.getAttribute("data-url");r&&window.open(r,"_blank")}}),e.querySelectorAll(".save-btn").forEach(t=>{t.onclick=r=>{r.stopPropagation();const s=t.getAttribute("data-key");k(s),L();const n=document.getElementById("products");if(n){const i=n.querySelector(`[data-key="${s}"]`);i&&(i.classList.remove("saved"),i.querySelector("svg").setAttribute("fill","none"))}}})}async function M(e){console.log("=== PROCESS NLP ITEMS START ==="),console.log("Item descriptions:",e),console.log("Current cached items:",S.size),console.log("Current found products:",m.size);const o=document.getElementById("products");for(const t of e){const r=t.toLowerCase().replace(/[^a-z0-9]/g,"-");if(console.log("Normalized key:",r),m.has(r)){console.log(`Skipping already found item: ${r}`);continue}if(w.has(r)){console.log(`Already searching for: ${r}`);continue}const s=D(t);if(s){console.log("Using cached result for:",t),m.set(r,{itemName:t,normalizedKey:r,...s,fromCache:!0}),E([...m.values()]);continue}if(w.add(r),m.size>0){const n=[...m.values()];n.push({itemName:t,loading:!0}),E(n)}else o.innerHTML='<div class="loading">üîç Searching for products...</div>';try{const n=await B(t);console.log("Search result for",t,":",n),S.set(t,n),m.set(r,{itemName:t,normalizedKey:r,...n})}catch(n){console.error("Error searching for",t,":",n),m.set(r,{itemName:t,normalizedKey:r,error:n.message})}finally{w.delete(r)}}m.size>0&&(console.log("Displaying all found products:",m.size),E([...m.values()])),console.log("=== PROCESS NLP ITEMS END ===")}document.addEventListener("DOMContentLoaded",async()=>{async function e(){const d=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput"),a=document.getElementById("camera-select");a.innerHTML=d.map((l,h)=>`<option value="${l.deviceId}">${l.label||"Camera "+(h+1)}</option>`).join("")}await e();const o=document.getElementById("camera-select"),t=o.parentElement;let r=!1;o.addEventListener("focus",()=>{r=!0,t.classList.add("open")}),o.addEventListener("blur",()=>{r=!1,setTimeout(()=>{r||t.classList.remove("open")},100)}),o.addEventListener("click",()=>{t.classList.contains("open")?t.classList.remove("open"):t.classList.add("open")});async function s(){if(!document.getElementById("camera-select").value){document.getElementById("results").innerText="Please select a camera first!";return}p&&await p.stop(),p=new R({apiUrl:"https://cluster1.overshoot.ai/api/v0.2",apiKey:F,prompt:'List all clothing items you see. For each item, describe it with as many parameters as it would take to recreate it with an image search, for example "stripped black and yellow short sleeve t-shirt for men" or "levis low taper navy blue jeans for women". Separate items with commas. At the start of each clothing item, list the rectangular coordinates of the bounds of the clothing item relative to the screen, for example [200, 200, 400, 400] would mean that the item spans from (x:200, y:200) pixel coord to (x:400, y:400) pixel coord.',source:{type:"camera",cameraFacing:"user"},processing:{clip_length_seconds:3,delay_seconds:2,fps:10,sampling_ratio:.1},onResult:a=>{console.log("Got NLP result:",a);let l="";if(typeof a=="string"?l=a:a.result?l=typeof a.result=="string"?a.result:JSON.stringify(a.result):l=JSON.stringify(a),console.log("Text result:",l),document.getElementById("results").innerText=l,l.toLowerCase().includes("none")||l.toLowerCase().includes("no clothing")){console.log("No clothing detected");return}const h=l.split(/[,\n]/).map(v=>v.trim()).filter(v=>v.length>0&&v.toLowerCase()!=="none");console.log("Parsed items:",h),h.length>0&&M(h)},onMessage:a=>{console.log("Got message:",a)},onStatusChange:a=>{console.log("Status changed:",a),document.getElementById("results").innerText="Status: "+a},onError:a=>{console.error("Vision error:",a),document.getElementById("results").innerText="An error occurred: "+(a.message||JSON.stringify(a))}}),await p.start(),console.log("Vision started with camera.")}document.getElementById("find-btn").onclick=()=>{document.getElementById("results").innerText="Detecting clothing...",s()},document.getElementById("clear-btn").onclick=()=>{console.log("Clearing all cached products..."),S.clear(),m.clear(),w.clear(),document.getElementById("products").innerHTML="",document.getElementById("results").innerText="",console.log("Cache cleared!")},document.getElementById("stop-btn").onclick=async()=>{p&&(console.log("Stopping Overshoot vision..."),await p.stop(),p=null,document.getElementById("results").innerText="Detection stopped.",console.log("Vision stopped."))},document.getElementById("start-btn").onclick=async()=>{const d=document.getElementById("camera-select").value,a=document.getElementById("preview");console.log("Starting camera with device:",d);try{const l=await navigator.mediaDevices.getUserMedia({video:{deviceId:d?{exact:d}:void 0}});a.srcObject=l,console.log("Camera started successfully"),await e()}catch(l){console.error("Error starting camera:",l),document.getElementById("results").innerText="Error starting camera: "+l.message}},document.querySelectorAll(".nav-item").forEach(i=>{i.addEventListener("click",()=>{const d=i.getAttribute("data-page");d&&d!=="sidepanel.html"&&(window.location.href=d)})})});
